var webArViewer=webArViewer||{};!function(e){webArViewer.scene=document.querySelector("a-scene");var t={C:{arNum:5},init:function(){this.setArg(),this.setArData()&&(this.setWrap(),this.createModel(),this.setScene()),this.setSwitcher()},setArg:function(){for(var e=this,t={},r=location.search.substring(1).split("&"),a=0;r[a];a++){var i=r[a].split("=");t[i[0]]=decodeURIComponent(i[1])}var n=new Array(e.C.arNum).join("0");t.warpList=t.fw&&(n+parseInt(t.fw,16).toString(2)).slice(-1*e.C.arNum).split("").reverse(),t.shodowList=t.fs&&(n+parseInt(t.fs,16).toString(2)).slice(-1*e.C.arNum).split("").reverse(),t.poyoList=t.fp&&(n+parseInt(t.fp,16).toString(2)).slice(-1*e.C.arNum).split("").reverse(),t.kiraList=t.fk&&(n+parseInt(t.fk,16).toString(2)).slice(-1*e.C.arNum).split("").reverse(),t.decaList=t.fd&&(n+parseInt(t.fd,16).toString(2)).slice(-1*e.C.arNum).split("").reverse(),t.sizeList=t.wh&&(n+n+parseInt(t.wh,16).toString(10)).slice(-2*e.C.arNum).match(/.{2}/g).reverse(),e.arg=t},setArData:function(){var r=this,e=document.createElement("a-assets");e.setAttribute("timeout","9000");for(var t=new Array(r.C.arNum),a=0;a<r.C.arNum;a=a+1|0){if(r.arg["i"+a]){var i=document.createElement("img");if(i.setAttribute("crossorigin","anonymous"),i.setAttribute("id","source"+a),i.setAttribute("src",r.arg["i"+a]),e.appendChild(i),r.arg["m"+a]){var n=document.createElement("img");n.setAttribute("crossorigin","anonymous"),n.setAttribute("id","map"+a),n.setAttribute("src",r.arg["m"+a]),e.appendChild(n)}}var s={path:r.arg["i"+a]};s.map=r.arg["m"+a],s.isWarp=r.arg.warpList&&!!Number(r.arg.warpList[a]),s.isShadow=r.arg.shodowList&&!!Number(r.arg.shodowList[a]),s.isPoyo=r.arg.poyoList&&!!Number(r.arg.poyoList[a]),s.isKira=r.arg.kiraList&&!!Number(r.arg.kiraList[a]),s.isDeca=r.arg.decaList&&!!Number(r.arg.decaList[a]),s.size=r.arg.sizeList?{w:.9*Number(r.arg.sizeList[a][0]),h:Number(r.arg.sizeList[a][1])}:{w:1.8,h:2},s.isDeca&&(s.size={w:10*s.size.w,h:10*s.size.h}),s.isGif=!!(r.arg["i"+a]||"").match(/\.gif$/i),t[a]=s}return t.some(function(e,t){return r.arg["i"+t]})?(webArViewer.scene.appendChild(e),r.arData=t,!0):(window.confirm("画像情報が1つも取得できませんでした。\nジェネレータで再度作り直してください。")&&(location.href="https://web-ar-generator.firebaseapp.com/"),!1)},setSwitcher:function(){var e=this,t=document.getElementById("swMarker"),r=document.getElementById("swGyro"),a=document.getElementById("swPreview"),i=document.getElementById("swHelp"),n=document.getElementById("helpContent"),s=document.getElementById("toggleCamera");if(i.addEventListener("click",function(){n.classList.toggle("hide"),i.classList.toggle("current")}),!e.arData||location.pathname.match(/vr/))return!1;e.arg.preview?a.classList.add("current"):e.arg.gyro?r.classList.add("current"):t.classList.add("current"),t.addEventListener("click",function(){this.classList.contains("current")||location.replace(location.search.replace("&gyro=1","").replace("&preview=1",""))}),r.addEventListener("click",function(){this.classList.contains("current")||location.replace(location.search.replace("&preview=1","")+"&gyro=1")}),a.addEventListener("click",function(){this.classList.contains("current")||location.replace(location.search.replace("&gyro=1","")+"&preview=1")}),s&&s.addEventListener("click",function(){location.pathname=location.pathname.match(/face/)?"":"/face/"})},setWrap:function(){var e=this,t=e.arg.offsetPos?decodeURI(e.arg.offsetPos):"0 0 0";e.wrap=document.createElement("a-entity"),e.wrap.setAttribute("position",t)},createModel:function(){for(var e=this,t=0;t<e.C.arNum;t=t+1|0){var r=e.arData[t];if(r.path)if(4!==t){if(t&&r.isShadow){var a=document.createElement("a-entity");a.setAttribute("position",AFRAME.utils.coordinates.stringify(e.positionVec3(t,"shadow"))),a.setAttribute("rotation","-90 0 0"),AFRAME.utils.entity.setComponentProperty(a,"geometry",{primitive:"plane",height:r.size.h,width:r.size.w}),AFRAME.utils.entity.setComponentProperty(a,"material",{shader:r.isGif?"gif":"flat",npot:!0,src:"#source"+t,transparent:!0,alphaTest:.1,color:"black",opacity:.3,depthTest:!1}),r.isPoyo&&(AFRAME.utils.entity.setComponentProperty(a,"animation__alpha",{property:"material.opacity",dir:"alternate",dur:400,easing:"easeInOutQuart",loop:!0,to:"0.1"}),AFRAME.utils.entity.setComponentProperty(a,"animation__scale",{property:"scale",dir:"alternate",dur:400,easing:"easeInOutQuart",loop:!0,to:"0.8 0.7 1"})),e.arData[t].shadow=a}var i=document.createElement("a-entity"),n=e.positionVec3(t,"main");if(i.setAttribute("position",AFRAME.utils.coordinates.stringify(n)),i.setAttribute("rotation",(0!==t||r.isWarp?0:-90)+" 0 0"),AFRAME.utils.entity.setComponentProperty(i,"material",{shader:r.isGif?"gif":"standard",npot:!0,src:"#source"+t,displacementMap:r.map?"#map"+t:null,displacementBias:-.5,side:"double",transparent:!0,alphaTest:.1,metalness:r.isKira?.1:0,roughness:r.isKira?.3:.5}),r.isWarp)if(t){var s,o;1!==t||e.arg.multi?(s=-32,o=64):(s=212,o=-64),AFRAME.utils.entity.setComponentProperty(i,"geometry",{primitive:"cylinder",openEnded:!0,thetaStart:s,thetaLength:o,height:r.size.h,radius:r.size.w,segmentsHeight:r.map?180:18,segmentsRadial:r.map?360:36})}else AFRAME.utils.entity.setComponentProperty(i,"geometry",{primitive:"sphere",radius:r.size.w/2,phiStart:-90,segmentsHeight:r.map?180:18,segmentsWidth:r.map?360:36});else AFRAME.utils.entity.setComponentProperty(i,"geometry",{primitive:"plane",height:r.size.h,width:r.size.w,segmentsHeight:r.map?180:1,segmentsWidth:r.map?180:1});r.isPoyo&&(AFRAME.utils.entity.setComponentProperty(i,"animation__pos",{property:"position",dir:"alternate",dur:400,easing:"easeInOutQuart",loop:!0,to:n.x+" "+(n.y+r.size.h/3)+" "+n.z}),AFRAME.utils.entity.setComponentProperty(i,"animation__scale",{property:"scale",dir:"alternate",dur:400,easing:"easeOutQuad",loop:!0,to:"0.94 1.06 1"})),0===t&&r.isShadow&&AFRAME.utils.entity.setComponentProperty(i,"animation__rot",{property:"rotation",dur:2e4,easing:"linear",loop:!0,to:(r.isWarp?0:-90)+" 360 0"}),e.arData[t].main=i}else{var p=document.createElement("a-sky");if(AFRAME.utils.entity.setComponentProperty(p,"material",{shader:r.isGif?"gif":"standard",src:"#source"+t,radius:r.isWarp?80:5e3}),r.isShadow&&AFRAME.utils.entity.setComponentProperty(p,"animation__rot",{property:"geometry.phiStart",dur:2e4,easing:"linear",loop:!0,to:-360}),webArViewer.scene.appendChild(p),r.isPoyo){var c=document.createElement("a-entity"),d=document.createElement("a-entity");c.setAttribute("light","type: hemisphere; color: #33F; groundColor: #BB3; intensity: 2"),d.setAttribute("light","type: directional; color: #FF3; intensity: 0.6"),d.setAttribute("position","-20 90 10"),webArViewer.scene.appendChild(c),webArViewer.scene.appendChild(d)}}}},setScene:function(){var r=this;if(r.arg.multi){if(!r.arg.gyro&&!r.arg.preview){for(t=0;t<r.C.arNum;t=t+1|0)if(r.arData[t].path&&4!==t){var e=document.createElement("a-marker");e.setAttribute("preset","custom"),e.setAttribute("type","pattern"),e.setAttribute("url","https://yoridrill.github.io/web-ar-viewer/asset/ar"+t+".patt"),r.arData[t].shadow&&e.appendChild(r.arData[t].shadow),r.arData[t].main&&e.appendChild(r.arData[t].main),webArViewer.scene.appendChild(e)}return}for(var t=0;t<r.C.arNum;t=t+1|0)if(r.arData[t].path&&4!==t){var a=document.createElement("a-entity");a.setAttribute("position",["0 0 0","2 0 -2.1","0 0 -2.3","-2 0 -2.2"][t]),r.arData[t].shadow&&a.appendChild(r.arData[t].shadow),r.arData[t].main&&a.appendChild(r.arData[t].main),r.wrap.appendChild(a)}}else r.arData[0].main&&!r.arData[0].isWarp&&r.wrap.appendChild(r.arData[0].main),r.arData[1].shadow&&r.wrap.appendChild(r.arData[1].shadow),r.arData[2].shadow&&r.wrap.appendChild(r.arData[2].shadow),r.arData[3].shadow&&r.wrap.appendChild(r.arData[3].shadow),r.arData[1].main&&r.wrap.appendChild(r.arData[1].main),r.arData[2].main&&r.wrap.appendChild(r.arData[2].main),r.arData[0].main&&r.arData[0].isWarp&&r.wrap.appendChild(r.arData[0].main),r.arData[3].main&&r.wrap.appendChild(r.arData[3].main);if(location.pathname.match(/vr/)){var i=r.arg.vrPos?decodeURI(r.arg.vrPos):"0 0 -4";r.wrap.setAttribute("position",i)}else if(r.arg.preview){(l=r.wrap.getAttribute("position")).z-=15,r.wrap.setAttribute("position",AFRAME.utils.coordinates.stringify(l)),r.wrap.setAttribute("rotation","25 0 0");var n,s=void 0!==document.ontouchstart,o=window.navigator.pointerEnabled,p=window.navigator.msPointerEnabled,c={start:o?"pointerdown":p?"MSPointerDown":s?"touchstart":"mousedown",move:o?"pointermove":p?"MSPointerMove":s?"touchmove":"mousemove",end:o?"pointerup":p?"MSPointerUp":s?"touchend":"mouseup",click:"click"},d=1;webArViewer.scene.addEventListener(c.start,function(e){var t=e.changedTouches?e.changedTouches[0]:e;n=t.pageY}),webArViewer.scene.addEventListener(c.move,function(e){var t=e.changedTouches?e.changedTouches[0]:e;n&&(d+=(t.pageY-n)/webArViewer.scene.clientHeight/5,AFRAME.utils.entity.setComponentProperty(r.wrap,"animation__scale",{property:"scale",dur:5,easing:"linear",loop:!1,to:d+" "+d+" "+d}))}),webArViewer.scene.addEventListener(c.end,function(e){n=null})}else if(r.arg.gyro){var l;(l=r.wrap.getAttribute("position")).y-=5,l.z-=8,r.wrap.setAttribute("position",AFRAME.utils.coordinates.stringify(l)),document.querySelector("a-camera-static").setAttribute("look-controls","look-controls")}else if(!r.arg.multi){var u=document.createElement("a-marker");return u.setAttribute("preset","custom"),u.setAttribute("type","pattern"),u.setAttribute("url","https://yoridrill.github.io/web-ar-viewer/asset/ar0.patt"),u.appendChild(r.wrap),void webArViewer.scene.appendChild(u)}webArViewer.scene.appendChild(r.wrap)},positionVec3:function(e,t){var r=this,a=r.arData[e].size.h/2,i=r.arData[e].size.w,n=r.arData[e].isWarp;return"shadow"===t?r.arg.multi?{x:0,y:0,z:-a}:{1:function(){return{x:0,y:0,z:-r.arData[0].size.h/2-a-(n?.2:0)}},2:function(){return{x:0,y:0,z:(n?.2:0)-a}},3:function(){return{x:0,y:0,z:r.arData[0].size.h/2-a+(n?.2:0)}}}[e]():0===e?{x:0,y:n?i/2:0,z:0}:r.arg.multi?{x:0,y:a,z:-(n?i:0)}:{1:function(){return{x:0,y:a,z:(n?i-.2:0)-r.arData[0].size.h/2}},2:function(){return{x:0,y:a,z:-(n?i-.2:0)}},3:function(){return{x:0,y:a,z:-(n?i-.2:0)+r.arData[0].size.h/2}}}[e]()}},r={cEle:null,videoDom:null,rLensTimer:null,init:function(){this.cEle=document.getElementById("rightlens"),this.cEle&&this.setEvents()},setEvents:function(){var r=this;webArViewer.scene.addEventListener("enter-vr",function(e){var t=r.cEle.getContext("2d");r.videoDom=document.querySelector("video"),r.videoDom.style.left="-20%",r.cEle.style.zIndex=-1,r.rLensTimer=setInterval(function(){r.cEle.width=r.videoDom.clientWidth,r.cEle.height=r.videoDom.clientHeight,r.cEle.style.marginTop=r.videoDom.style.marginTop,r.cEle.style.top=r.videoDom.style.top,t.drawImage(r.videoDom,r.videoDom.videoWidth/10,0,9*r.videoDom.videoWidth/10,r.videoDom.videoHeight,0,0,9*r.videoDom.videoWidth/10,r.videoDom.videoHeight)},1e3/60)}),webArViewer.scene.addEventListener("exit-vr",function(e){r.videoDom.style.left="0px",r.cEle.style.zIndex=-5,clearInterval(r.rLensTimer)})}};webArViewer.ar=t,webArViewer.vr=r,webArViewer.ar.init(),webArViewer.vr.init()}();