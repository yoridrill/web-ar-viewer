var webArViewer=webArViewer||{};!function(e){webArViewer.scene=document.querySelector("a-scene");var t={C:{arNum:4},init:function(){this.setArg(),this.setArData()&&(this.setWrap(),this.createModel()),this.setSwitcher()},setArg:function(){for(var e=this,t={},i=location.search.substring(1).split("&"),r=0;i[r];r++){var a=i[r].split("=");t[a[0]]=decodeURIComponent(a[1])}var n=new Array(e.C.arNum).join("0");t.warpList=t.fw&&(n+parseInt(t.fw,16).toString(2)).slice(-1*e.C.arNum).split("").reverse(),t.shodowList=t.fs&&(n+parseInt(t.fs,16).toString(2)).slice(-1*e.C.arNum).split("").reverse(),t.poyoList=t.fp&&(n+parseInt(t.fp,16).toString(2)).slice(-1*e.C.arNum).split("").reverse(),t.decaList=t.fd&&(n+parseInt(t.fd,16).toString(2)).slice(-1*e.C.arNum).split("").reverse(),t.sizeList=t.wh&&(n+n+parseInt(t.wh,16).toString(10)).slice(-2*e.C.arNum).match(/.{2}/g).reverse(),e.arg=t},setArData:function(){var r=this,a=document.createElement("a-assets"),n=new Array(r.C.arNum+1).join("0").split("");return n.some(function(e,t){return r.arg["i"+t]})?(n.forEach(function(e,t){if(n[t]={path:r.arg["i"+t]},n[t].isWarp=r.arg.warpList&&!!Number(r.arg.warpList[t]),n[t].isShadow=r.arg.shodowList&&!!Number(r.arg.shodowList[t]),n[t].isPoyo=r.arg.poyoList&&!!Number(r.arg.poyoList[t]),n[t].isDeca=r.arg.decaList&&!!Number(r.arg.decaList[t]),n[t].size=r.arg.sizeList?{w:.9*Number(r.arg.sizeList[t][0]),h:Number(r.arg.sizeList[t][1])}:{w:1.8,h:2},n[t].isDeca&&(n[t].size={w:10*n[t].size.w,h:10*n[t].size.h}),n[t].isGif=!!(r.arg["i"+t]||"").match(/\.gif$/i),r.arg["i"+t]){var i=document.createElement("img");i.setAttribute("crossorigin","anonymous"),i.setAttribute("id","source"+t),i.setAttribute("src",r.arg["i"+t]),a.appendChild(i),webArViewer.scene.appendChild(a)}}),r.arData=n,!0):(window.confirm("画像情報が1つも取得できませんでした。\nジェネレータで再度QRコードを発行し直してください。")&&(location.href="https://web-ar-generator.firebaseapp.com/"),!1)},setSwitcher:function(){var e=this,t=document.getElementById("swMarker"),i=document.getElementById("swGyro"),r=document.getElementById("swPreview"),a=document.getElementById("swHelp"),n=document.getElementById("helpContent");if(a.addEventListener("click",function(){n.classList.toggle("hide"),a.classList.toggle("current")}),!e.arData)return!1;e.arg.preview?r.classList.add("current"):e.arg.gyro?i.classList.add("current"):t.classList.add("current"),t.addEventListener("click",function(){this.classList.contains("current")||(location.href=location.search.replace("&gyro=1","").replace("&preview=1",""))}),i.addEventListener("click",function(){this.classList.contains("current")||(location.href=location.search.replace("&preview=1","")+"&gyro=1")}),r.addEventListener("click",function(){this.classList.contains("current")||(location.href=location.search.replace("&gyro=1","")+"&preview=1")})},setWrap:function(){var e=this;if(e.arg.preview){(s=document.createElement("a-entity")).setAttribute("position","0 0 -15"),s.setAttribute("rotation","25 0 0");document.querySelector("a-camera-static");var i,t=void 0!==document.ontouchstart,r=window.navigator.pointerEnabled,a=window.navigator.msPointerEnabled,n={start:r?"pointerdown":a?"MSPointerDown":t?"touchstart":"mousedown",move:r?"pointermove":a?"MSPointerMove":t?"touchmove":"mousemove",end:r?"pointerup":a?"MSPointerUp":t?"touchend":"mouseup",click:"click"},o=1;webArViewer.scene.addEventListener(n.start,function(e){var t=e.changedTouches?e.changedTouches[0]:e;i=t.pageY}),webArViewer.scene.addEventListener(n.move,function(e){var t=e.changedTouches?e.changedTouches[0]:e;i&&(o+=(t.pageY-i)/webArViewer.scene.clientHeight/5,AFRAME.utils.entity.setComponentProperty(s,"animation__scale",{property:"scale",dur:400,easing:"easeInOutQuad",loop:!1,to:o+" "+o+" "+o}))}),webArViewer.scene.addEventListener(n.end,function(e){i=null})}else if(e.arg.gyro){(s=document.createElement("a-entity")).setAttribute("position","0 -5 -8"),document.querySelector("a-camera-static").setAttribute("look-controls","look-controls")}else{var s;(s=document.createElement("a-marker")).setAttribute("preset","custom"),s.setAttribute("type","pattern"),s.setAttribute("url","asset/pattern-marker.patt")}e.wrap=s},createModel:function(){var o=this;o.arData.forEach(function(e,t){if(e.path){var i=e.size.h/2;if(t&&e.isShadow){var r=document.createElement("a-entity"),a=[{x:0,y:0,z:0},{x:0,y:-.2,z:-o.arData[0].size.h/2-i},{x:0,y:-.1,z:-i},{x:0,y:0,z:o.arData[0].size.h/2-i}];r.setAttribute("position",AFRAME.utils.coordinates.stringify(a[t])),r.setAttribute("rotation","-90 0 0"),AFRAME.utils.entity.setComponentProperty(r,"geometry",{primitive:"plane",height:e.size.h,width:e.size.w}),AFRAME.utils.entity.setComponentProperty(r,"material",{shader:e.isGif?"gif":"standard",npot:!0,src:"#source"+t,color:"black",opacity:.3}),e.isPoyo&&(AFRAME.utils.entity.setComponentProperty(r,"animation__alpha",{property:"material.opacity",dir:"alternate",dur:400,easing:"easeInOutQuart",loop:!0,to:"0.1"}),AFRAME.utils.entity.setComponentProperty(r,"animation__scale",{property:"scale",dir:"alternate",dur:400,easing:"easeInOutQuart",loop:!0,to:"0.8 0.7 1"})),o.wrap.appendChild(r)}var n=document.createElement("a-entity");a=[{x:0,y:e.isWarp?i:0,z:0},{x:0,y:i,z:(e.isWarp?e.size.w:0)-o.arData[0].size.h/2},{x:0,y:i,z:-(e.isWarp?e.size.w:0)},{x:0,y:i,z:o.arData[0].size.h/2-(e.isWarp?e.size.w:0)}];if(n.setAttribute("position",AFRAME.utils.coordinates.stringify(a[t])),n.setAttribute("rotation",(0!==t||e.isWarp?0:-90)+" 0 0"),AFRAME.utils.entity.setComponentProperty(n,"material",{shader:e.isGif?"gif":"standard",npot:!0,src:"#source"+t,side:"double",transparent:!0,alphaTest:.1}),e.isWarp)if(t){AFRAME.utils.entity.setComponentProperty(n,"geometry",{primitive:"cylinder",openEnded:!0,thetaStart:[0,212,-32,-32][t],thetaLength:1===t?-64:64,height:e.size.h,radius:e.size.w})}else AFRAME.utils.entity.setComponentProperty(n,"geometry",{primitive:"sphere",radius:i-.25,phiStart:-90});else AFRAME.utils.entity.setComponentProperty(n,"geometry",{primitive:"plane",height:e.size.h,width:e.size.w});e.isPoyo?(AFRAME.utils.entity.setComponentProperty(n,"animation__pos",{property:"position",dir:"alternate",dur:400,easing:"easeInOutQuart",loop:!0,to:a[t].x+" "+(a[t].y+e.size.h/3)+" "+a[t].z}),AFRAME.utils.entity.setComponentProperty(n,"animation__scale",{property:"scale",dir:"alternate",dur:400,easing:"easeOutQuad",loop:!0,to:"0.94 1.06 1"})):0===t&&e.isShadow&&AFRAME.utils.entity.setComponentProperty(n,"animation__rot",{property:"rotation",dur:2e4,easing:"linear",loop:!0,to:(e.isWarp?0:-90)+" 360 0"}),o.arData[t].main=n}}),o.arData[1].main&&o.wrap.appendChild(o.arData[1].main),o.arData[2].main&&o.wrap.appendChild(o.arData[2].main),o.arData[3].main&&o.wrap.appendChild(o.arData[3].main),o.arData[0].main&&o.wrap.appendChild(o.arData[0].main),webArViewer.scene.appendChild(o.wrap)}},i={cEle:document.getElementById("rightlens"),videoDom:null,rLensTimer:null,init:function(){this.setEvents()},setEvents:function(){var i=this;webArViewer.scene.addEventListener("enter-vr",function(e){var t=i.cEle.getContext("2d");i.videoDom=document.querySelector("video"),i.videoDom.style.left="-20%",i.cEle.style.zIndex=-1,i.rLensTimer=setInterval(function(){i.cEle.width=i.videoDom.clientWidth,i.cEle.height=i.videoDom.clientHeight,i.cEle.style.marginTop=i.videoDom.style.marginTop,i.cEle.style.top=i.videoDom.style.top,t.drawImage(i.videoDom,i.videoDom.videoWidth/10,0,9*i.videoDom.videoWidth/10,i.videoDom.videoHeight,0,0,9*i.videoDom.videoWidth/10,i.videoDom.videoHeight)},1e3/60)}),webArViewer.scene.addEventListener("exit-vr",function(e){i.videoDom.style.left="0px",i.cEle.style.zIndex=-5,clearInterval(i.rLensTimer)})}};webArViewer.ar=t,webArViewer.vr=i,webArViewer.ar.init(),webArViewer.vr.init()}();